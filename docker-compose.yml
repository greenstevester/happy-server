version: '3.8'

services:
    happy-server:
        build: .
        ports:
            - "127.0.0.1:13005:3000"  # Localhost only - use Cloudflare Tunnel for public access
        env_file:
            - .env.docker
        environment:
            - NODE_ENV=production
            - PORT=3000
            - DATABASE_URL=postgresql://happy:happy@postgres:5432/happy
            - REDIS_URL=redis://redis:6379
            - S3_HOST=minio
            - S3_PORT=9000
            - S3_USE_SSL=false
            - S3_ACCESS_KEY=happyadmin
            - S3_SECRET_KEY=happyadmin123
            - S3_BUCKET=happy
            - S3_PUBLIC_URL=${S3_PUBLIC_URL:-http://localhost:19000/happy}
        depends_on:
            migrate:
                condition: service_completed_successfully
            redis:
                condition: service_healthy
            minio-init:
                condition: service_completed_successfully
        restart: unless-stopped

    migrate:
        build: .
        env_file:
            - .env.docker
        environment:
            - DATABASE_URL=postgresql://happy:happy@postgres:5432/happy
        command: npx prisma migrate deploy
        depends_on:
            postgres:
                condition: service_healthy

    postgres:
        image: postgres:16
        ports:
            - "127.0.0.1:15432:5432"  # Localhost only for debugging
        environment:
            - POSTGRES_USER=happy
            - POSTGRES_PASSWORD=happy
            - POSTGRES_DB=happy
        volumes:
            - postgres_data:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U happy -d happy"]
            interval: 5s
            timeout: 5s
            retries: 5
        restart: unless-stopped

    redis:
        image: redis:7-alpine
        ports:
            - "127.0.0.1:16379:6379"  # Localhost only for debugging
        volumes:
            - redis_data:/data
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 5s
            timeout: 5s
            retries: 5
        restart: unless-stopped

    minio:
        image: minio/minio
        ports:
            - "127.0.0.1:19000:9000"  # S3 API - expose via Cloudflare Tunnel for file access
            - "127.0.0.1:19001:9001"  # Console - localhost only
        environment:
            - MINIO_ROOT_USER=happyadmin
            - MINIO_ROOT_PASSWORD=happyadmin123
        volumes:
            - minio_data:/data
        command: server /data --console-address ":9001"
        healthcheck:
            test: ["CMD", "mc", "ready", "local"]
            interval: 5s
            timeout: 5s
            retries: 5
        restart: unless-stopped

    minio-init:
        image: minio/mc
        depends_on:
            minio:
                condition: service_healthy
        entrypoint: >
            /bin/sh -c "
            mc alias set local http://minio:9000 happyadmin happyadmin123 &&
            mc mb -p local/happy || true &&
            mc anonymous set download local/happy
            "

volumes:
    postgres_data:
    redis_data:
    minio_data:
